# Haskell: Build tools (настраиваем окружение)

Данный документ описывает рекомендуемые способы по работе с Haskell в плане сборки проектов.

## Build tools (установка)

Программы на языке Haskell пишутся в файлах с расширением `.hs`.

> На самом деле есть ещё `.lhs`, но в рамках курса мы эту тему затрагивать не будем.

Haskell является компилируемым языком. Компилятором Haskell (основным и, можно считать, единственным) является [GHC](https://downloads.haskell.org/~ghc/latest/docs/html/users_guide/). Предполагается, что решения домашних заданий будут разделены на несколько файлов (называемых _модулями_) и будут использовать сторонние библиотеки. Поэтому намного удобней организовать решения в _проекты_. А чтобы работать с проектами, необходимо использовать билд-тулу (программу, занимающеся компиляцией целого проекта, состоящего из нескольких модулей и используещего различные библиотеки).

На данный момент существует несколько сборщиков проектов:

1. `stack`
   * https://docs.haskellstack.org/en/stable/README/
1. `cabal-install` (далее просто `cabal`)
   * https://www.haskell.org/cabal/users-guide/index.html


Ниже будут описансы способы по установке инструментов компиляции проектов.

### `stack` (рекомендуемый)

Рекомендации по установке `stack` находятся по этой ссылке:

* https://docs.haskellstack.org/en/stable/README/#how-to-install

Там есть инструкции для каждой системы.

С помощью команды `stack new project` можно создать проект с названием `project`.

Скомпилировать проект: `stack build`
Запустить ghci из проекта: `stack ghci`

### `cabal` (для общего развития)
А оно вам нужно?

## Установка GHC

Последняя вышедшая версия компилятора GHC: 8.8.2. Во время курса будем использовать её.

```
sudo apt install ghc-8.8.2
```

Можно проверить, что используются последние версии (версия `ghc` на момент прохождения инструкции может быть новее).

```shell
$ /opt/ghc/8.8.2/bin/ghc --version
The Glorious Glasgow Haskell Compilation System, version 8.8.2
$ /opt/cabal/head/bin/stack --version
```

#### Создание первого проекта

Склонируйте репозиторий с классрума, или добавьте апстрим к уже существующему локальному репозиторию. Содержимое папки с проектом должно выглядеть следующим образом:

```shell=
$ tree .
.
├── Setup.hs
├── app
│   └── Main.hs
├── package.yaml
├── src
│   └── HW<Number>
│       └── T1.hs
│       └── T2.hs
│       └── T3.hs
│       └── ...
├── stack.yaml
├── stack.yaml.lock
├── test
│   └── Spec.hs
├── <project-name>.cabal
└── toy-compiler.iml
```
Данная структура является базовой для проектов, создаваемых с помощью `stack new`.

#### Создание первого модуля

Создайте в папочке `src` файл с названием `Dummy.hs` и поместите в него следующий код:

```haskell=
module Dummy where

inc :: Int -> Int
inc x = x + 1
```

После этого нужно отредактировать `.cabal` файл. Это можно сделать двумя способами.

### Вручную (не рекомендуется)

Отредактируйте строчку `exposed-modules` чтобы она приобрела следующий вид.

```
  exposed-modules: Dummy
```

> **NOTE:** все модули проекта должны быть перечислены в `exposed-modules`, чтобы они компилировались.

### С помощью hpack (рекомендуемый)

Чтобы не заморачиваться с `.cabal` файлом (и вообще стараться трогать его как можно меньше) можно использовать специальную утилиту `hpack`. Она позволяет генерировать правильный `.cabal` файл с помощью файла `package.yaml`. В этом файле вы в основном будете перечислять имеющиеся зависимости от сторонних библиотек. По умолчанию `hpack` автоматически используется каждый раз, когда вы используете `stack build`.

#### Шаг 5: Сборка проекта

Сначала из корня проекта надо запустить команду `stack new <имя проекта>`.

После этого надо набрать команду `stack build`, чтобы скомпилировать проект.

> Если что-то не билдится или идёт не так, то в крайнем случае можно удалить папку `.stack-work`.

Вы должны увидеть, что файл `Dummy` скомпилировался.

После этого можно запустить `ghci`, и вызвать оттуда функцию `inc`, чтобы убедиться в её работе!

Итого:

```shell=
$ stack new <имя проекта>
$ cd <имя проекта>
$ stack build
$ stack ghci

...

Prelude> inc 4
5
```
### Добавление зависимостей

> В первом домашнем задании не потребуются библиотеки кроме `base`, поэтому пока можно сильно не задумываться о зависимостях.

Для добавления зависимостей будем использовать небезызвестный `package.yaml` файл. Если вы откроете его (созданный `stack new`) то увидите что он разделен на три секции - `library`, `executable` и `tests`. По умолчанию считается что часть `library` отвечает за все модули в папке `src`, `executables` - `app`, `tests` - `test`. В каждую из этих секций можно добавить (если его там нет) пункт `dependencies` и списком через - перечислить все сторониие (имеющиеся на `hackage`) пакеты, которые вам нужны. Добавление пакета в любую из секций не добавляет его в две оставшиеся. Если нужно добавить пакет во все секции, то `dependencies` нужно прописать отдельно от них всех.